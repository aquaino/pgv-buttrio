{% macro table_scripts(table_id) %}
  <script>
    $(document).ready(function() {
      // DataTable configuration
      var table = $("#{{ table_id }}").DataTable({
        // dom: "Blftrip",
        dom: "<'uk-flex uk-flex-between uk-flex-wrap'<'uk-margin-small-bottom' B><'uk-margin-small-bottom' f><l>>" + "<'uk-margin-remove't>" + "<'uk-flex uk-flex-between uk-flex-wrap'<'uk-margin-small-bottom uk-text-muted' i><p>>",
        "pageLength": 25,
        "columnDefs": [
          { "targets": [$('#{{ table_id }} thead tr th').length - 1], "orderable": false }
        ],
        order: [],
        language: {
          url: "//cdn.datatables.net/plug-ins/1.10.24/i18n/Italian.json",
          buttons: {
            excel: "Excel",
            pdf: "PDF",
            print: "Stampa"
          }
        },
        buttons: {
          buttons: ["excel", "pdf", "print"],
          dom: {
            button: {
              className: "uk-button uk-button-default uk-button-small"
            }
          }
        },
        initComplete: function() {
          this.api().columns().every(function() {
              var column = this;
              var select = $('<select class="uk-select uk-form-small"><option value=""></option></select>')
                .appendTo($(column.footer()).empty())
                .on('change', function() {
                  var val = $.fn.dataTable.util.escapeRegex(
                    $(this).val()
                  );
                  column.search(val ? '^' + val + '$' : '', true, false).draw();
                });

              column.data().unique().sort().each(function (d, j) {
                  select.append('<option value="' + d + '">' + d + '</option>')
              });
          });
        }
      });
    });
  </script>
{% endmacro %}

{% macro replace_if_none(value) %}
  {{ value|default("-", true) }}
{% endmacro %}

{% macro render_item_buttons(update_url, duplicate_url, delete_url) %}
  <td>
    <div class="item-buttons uk-flex-inline">
      {% if update_url %}
        <a href="{{ update_url }}" title="Modifica" class="uk-icon-button uk-text-primary uk-background-default" uk-icon="icon: cog; ratio: .85;"></a>
      {% endif %}
      {% if duplicate_url %}
        <a href="{{ duplicate_url}}" title="Duplica" class="uk-icon-button uk-text-primary uk-background-default" uk-icon="icon: copy; ratio: .85;"></a>
      {% endif %}
      {% if delete_url %}
        <a href="{{ delete_url }}" title="Elimina" class="uk-icon-button uk-text-primary uk-background-default" uk-icon="icon: trash; ratio: .85;"></a>
      {% endif %}
    </div>
  </td>

  <style>
    .item-buttons a {
      width: 28px;
      height: 28px;
      margin-left: 6px;
    }
  </style>
{% endmacro %}

{% macro render_users_table(title, users, all_flag) %}
  <div class="uk-card uk-card-small uk-card-default">
    <div class="uk-card-header uk-flex uk-flex-between uk-flex-middle">
      <h3 class="uk-card-title uk-margin-remove">{{ title }}</h3>
      <span class="uk-label uk-background-muted uk-text-muted">{{ users|length }} volontari</span>
    </div>
    <div class="uk-card-body">
      {% if not all_flag %}
        {% set headers = ["Cognome", "Nome", "Genere", "Nato il", "Nato a", "CAP", "Città", "Indirizzo", "Email 1", "Email 2", "Tel 1", "Tel 2", "Tipologia", "Note"] %}
      {% else %}
        {% set headers = ["Cognome", "Nome", "Genere", "Nato il", "Nato a", "CAP", "Città", "Indirizzo", "Email 1", "Email 2", "Tel 1", "Tel 2", "Note"] %}
      {% endif %}
      {% set table_id = title.replace(" ", "-").lower() + "-table" %}
      <div class="uk-overflow-auto">
        <table id="{{ table_id }}" class="uk-table uk-table-small uk-table-striped uk-table-hover">
          <thead>
            <tr>
              {% if not all_flag %}
                <th></th>
              {% endif %}
              {% for header in headers%}
                <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              {% if not all_flag %}
                {{ render_item_buttons(url_for('users.update_user', user_id=user.id), url_for('users.duplicate_user', user_id=user.id, subtype_id=user.subtype_id), url_for('users.delete_user', user_id=user.id, subtype_id=user.subtype_id)) }}
              {% endif %}
              <td>{{ replace_if_none(user.lastname) }}</td>
              <td>{{ replace_if_none(user.firstname) }}</td>
              <td>{{ replace_if_none(user.gender) }}</td>
              {% if user.born_on == None %}
                <td>{{ replace_if_none(user.born_on) }}</td>
              {% else %}
                <td>{{ user.born_on.strftime('%d/%m/%Y') }}</td>
              {% endif %}
              <td>{{ replace_if_none(user.born_in) }}</td>
              <td>{{ replace_if_none(user.zip) }}</td>
              <td>{{ replace_if_none(user.city) }}</td>
              <td>{{ replace_if_none(user.address) }}</td>
              <td>{{ replace_if_none(user.email1) }}</td>
              <td>{{ replace_if_none(user.email2) }}</td>
              <td>{{ replace_if_none(user.tel1) }}</td>
              <td>{{ replace_if_none(user.tel2) }}</td>
              {% if not all_flag %}
                <td>{{ user.subtype_name }}</td>
              {% endif %}
              <td>{{ replace_if_none(user.notes) }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              {% for header in headers%}
                <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </tfoot>
        </table>
      </div>
      {{ table_scripts(table_id) }}
    </div>
  </div>
{% endmacro %}

{% macro render_events_table(title, events) %}
  <div class="uk-card uk-card-small uk-card-default">
    <div class="uk-card-header uk-flex uk-flex-between uk-flex-middle">
      <h3 class="uk-card-title uk-margin-remove">{{ title }}</h3>
      <span class="uk-label uk-background-muted uk-text-muted">{{ events|length }} eventi</span>
    </div>
    <div class="uk-card-body">
      {% set headers = ["Categoria Libro Verde", "Evento", "Descrizione"] %}
      {% set table_id = title.replace(" ", "-").lower() + "-table" %}
      <div class="uk-overflow-auto">
        <table id="{{ table_id }}" class="uk-table uk-table-small uk-table-striped uk-table-hover">
          <thead>
            <tr>
              <th></th>
              {% for header in headers%}
                <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for event in events %}
            <tr>
              {{ render_item_buttons(url_for('events.update_event', event_id=event.id), url_for('events.duplicate_event', event_id=event.id), url_for('events.delete_event', event_id=event.id)) }}
              <td>{{ event.cat_name }}</td>
              <td>{{ event.name }}</td>
              <td>{{ replace_if_none(event.descr) }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              {% for header in headers%}
                <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </tfoot>
        </table>
      </div>
      {{ table_scripts(table_id) }}
    </div>
  </div>
{% endmacro %}

{% macro render_activities_table(title, activities) %}
  <div class="uk-card uk-card-small uk-card-default">
    <div class="uk-card-header uk-flex uk-flex-between uk-flex-middle">
      <h3 class="uk-card-title uk-margin-remove">{{ title }}</h3>
      <span class="uk-label uk-background-muted uk-text-muted">{{ activities|length }} attività</span>
    </div>
    <div class="uk-card-body">
      {% set headers = ["Data", "Volontario", "Tipologia vol.", "Evento", "Attività", "Inizio", "Fine", "Luogo", "Note"] %}
      {% set table_id = title.replace(" ", "-").lower() + "-table" %}
      <div class="uk-overflow-auto">
        <table id="{{ table_id }}" class="uk-table uk-table-small uk-table-striped uk-table-hover">
          <thead>
            <tr>
              <th></th>
              {% for header in headers%}
                <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for activity in activities %}
            <tr>
              {{ render_item_buttons(url_for('activities.update_activity', activity_id=activity.id), url_for('activities.duplicate_activity', activity_id=activity.id), url_for('activities.delete_activity', activity_id=activity.id)) }}
              <td>{{ activity.date.strftime('%d/%m/%Y') }}</td>
              {% with user = activity.lastname + " " + activity.firstname %}
                <td>{{ user }}</td>
              {% endwith %}
              <td>{{ activity.subtype }}</td>
              <td>{{ activity.event }}</td>
              <td>{{ activity.activity }}</td>
              <td>{{ activity.start_time }}</td>
              <td>{{ activity.end_time }}</td>
              <td>{{ activity.location }}</td>
              <td>{{ replace_if_none(activity.notes) }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              {% for header in headers%}
                <th>{{ header }}</th>
              {% endfor %}
            </tr>
          </tfoot>
        </table>
      </div>
      {{ table_scripts(table_id) }}
    </div>
  </div>
{% endmacro %}
